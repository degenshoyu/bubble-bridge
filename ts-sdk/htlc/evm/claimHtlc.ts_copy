import "dotenv/config";
import { ethers } from "ethers";
import { getLatestHtlcInfoEvm } from "../../utils/getLatestHtlcInfoEvm";
import { getLatestEvmDeployment } from "../../utils/deployments-evm";
import { getLatestHtlcInfo } from "../../utils/getLatestHtlcInfo";
import { loadEvmPrivateKey } from "../../utils/loadKeypair";
import path from "path";
import fs from "fs";

async function main() {
  const evmInfo = getLatestHtlcInfoEvm();
  if (!evmInfo.swapId) {
    throw new Error("âŒ Missing swapId in EVM lock JSON.");
  }

  const suiInfo = getLatestHtlcInfo();
  if (!suiInfo.secret) {
    throw new Error("âŒ Missing secret in Sui JSON.");
  }

  const { contractAddress, abi } = getLatestEvmDeployment();
  const provider = new ethers.JsonRpcProvider(process.env.EVM_SEPOLIA_RPC_URL);
  const signer = loadEvmPrivateKey("EVM_CLAIMER_PRIVKEY").connect(provider);

  const secret = suiInfo.secret.startsWith("0x")
    ? suiInfo.secret.slice(2)
    : suiInfo.secret;

  console.log("ğŸ” Initiator Claimer Address:", await signer.getAddress());
  console.log("ğŸ“¦ Claiming HTLC swapId:", evmInfo.swapId);
  console.log("ğŸ”‘ Secret (hex):", secret);
  console.log("ğŸ§¾ Secret Source: Sui JSON", suiInfo.sourceFile);

  const contract = new ethers.Contract(contractAddress, abi, signer);

  const tx = await contract.claim(evmInfo.swapId, secret);
  console.log("ğŸš€ Sent claim tx:", tx.hash);
  await tx.wait();
  console.log("ğŸ‰ HTLC claimed successfully!");

  const claimsDir = path.join(
    __dirname,
    "../../../deployments/htlc-claims-evm"
  );
  fs.mkdirSync(claimsDir, { recursive: true });

  const filename = `${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
  const filepath = path.join(claimsDir, filename);

  const log = {
    txHash: tx.hash,
    claimer: await signer.getAddress(),
    swapId: evmInfo.swapId,
    secret: "0x" + secret,
    sourceFile: evmInfo.sourceFile,
    timestamp: new Date().toISOString(),
  };

  fs.writeFileSync(filepath, JSON.stringify(log, null, 2));
  console.log("ğŸ§¾ Saved claim info to", filepath);
}

main().catch((err) => {
  console.error("âŒ Initiator claim failed:", err);
  process.exit(1);
});
