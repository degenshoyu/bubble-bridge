#!/bin/bash

if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <RECIPIENT_ADDRESS>"
  exit 1
fi

RECIPIENT="$1"
SCRIPT_DIR="$(dirname "$0")"
PACKAGE_ID=$(cat "$SCRIPT_DIR/last_package_id.txt")
HASH_LOCK_HEX=$(jq -r '.hash_lock' "$SCRIPT_DIR/last_hash.json")

AMOUNT=100000000
TIMELOCK=$(($(date +%s) + 300))

HASH_VEC=$(echo "$HASH_LOCK_HEX" | sed 's/../0x&,/g' | sed 's/,$//')

echo "ğŸ“¦ PACKAGE_ID: $PACKAGE_ID"
echo "ğŸ¯ RECIPIENT: $RECIPIENT"
echo "ğŸ” HASH_LOCK: $HASH_LOCK_HEX"
echo "ğŸ•’ TIMELOCK: $TIMELOCK"
echo "ğŸ’° AMOUNT: $AMOUNT"

RESPONSE=$(sui client call \
  --package "$PACKAGE_ID" \
  --module htlc \
  --function lock \
  --args "$RECIPIENT" "[$HASH_VEC]" "$TIMELOCK" "$AMOUNT" \
  --gas-budget 500000000 \
  --json)

HTLC_ID=$(echo "$RESPONSE" | jq -r --arg pkg "$PACKAGE_ID" '.objectChanges[] | select(.type == "created" and (.objectType | startswith("\($pkg)::htlc::HTLC"))) | .objectId')

OUT_FILE="$SCRIPT_DIR/last_htlc_object.json"
echo "{\"htlc_id\": \"$HTLC_ID\"}" > "$OUT_FILE"

echo "âœ… HTLC object created: $HTLC_ID"
echo "ğŸ“ Saved to: $OUT_FILE"
